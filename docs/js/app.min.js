var markedRenderer,viewModel;(markedRenderer=new marked.Renderer).link=function(t,e,s){return'<a target="_blank" href="'+t+'" title="'+e+'">'+s+"</a>"},marked.setOptions({renderer:markedRenderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1}),viewModel=function(){this.currentPage=ko.observable("splash"),this.tasks=ko.observableArray(),this.currentFilter=ko.observable("all"),this.currentProjectId=ko.observable(""),this.allProjects=ko.observableArray(),this.allTasklists=ko.observableArray(),this.prevResponse="",this.creatingTask=ko.observable(!1),this.loadingTasks=ko.observable(!1),this.selectedTasklist=ko.observable(),this.searchTerm=ko.observable("").extend({rateLimit:500}),this.User=new User,this.domain=ko.observable(),this.userId=ko.observable(),this.userIcon=ko.observable(),this.userFirstname=ko.observable(),this.previousPage=ko.observable(),this.showNav=ko.observable(!1),this.lightNav=ko.observable(!1),this.backButton=ko.observable(!1),this.loginError=ko.observable(),this.today=moment(new Date).format("YYYYMMDD"),document.addEventListener("mousemove",()=>(this.autoRefresh&&clearInterval(this.autoRefresh),this.autoRefresh=this.setInterval(()=>this.getAllTasks(),6e4))),this.greeting=ko.pureComputed(()=>{var t;return(t=moment(new Date).format("HH"))<4?"Hey":t<12?"Good morning":t<17?"Good afternoon":"Good evening"}),this.totalTasks=ko.pureComputed(()=>this.tasks().length),this.totalLate=ko.pureComputed(()=>ko.utils.arrayFilter(this.tasks(),function(t){return"late"===t.taskType}).length),this.totalToday=ko.pureComputed(()=>ko.utils.arrayFilter(this.tasks(),function(t){return"today"===t.taskType}).length),this.totalUpcoming=ko.pureComputed(()=>ko.utils.arrayFilter(this.tasks(),function(t){return"upcoming"===t.taskType}).length),this.searchResults=ko.pureComputed(()=>this.searchTerm()?ko.utils.arrayFilter(this.tasks(),function(t){return t.taskName.toLowerCase().indexOf(searchTerm().toLowerCase())>-1||t.taskDescriptionRaw.toLowerCase().indexOf(searchTerm().toLowerCase())>-1}):[]),this.currentPage.subscribe(t=>{this.previousPage(t)},this,"beforeChange"),this.currentPage.subscribe(t=>{["dashboard"].indexOf(t)>-1?(this.showNav(!0),this.lightNav(!0),this.backButton(!1),this.currentFilter("all"),this.currentProjectId("")):["add-task","project","tasks-view","search"].indexOf(t)>-1?(this.showNav(!0),this.lightNav(!1),this.backButton(!0)):this.showNav(!1),setTimeout(function(){return"search"===t?document.getElementById("search-term").focus():"add-task"===t?document.getElementById("task-name").focus():void 0},50)}),this.filteredTasks=ko.pureComputed(()=>ko.utils.arrayFilter(this.tasks(),t=>(""===this.currentProjectId()||this.currentProjectId()===t.projectId)&&("all"===this.currentFilter()||this.currentFilter()===t.taskType)),this),this.projects=ko.pureComputed(()=>{var t,e;return e=[],t=[],ko.utils.arrayForEach(this.filteredTasks(),s=>{var a;if(e.indexOf(s.projectId)<0)return a={projectId:s.projectId,projectName:s.projectName,taskCount:this.getTaskCount(s.projectId),lateCount:this.getTaskCount(s.projectId,"late"),todayCount:this.getTaskCount(s.projectId,"today"),upcomingCount:this.getTaskCount(s.projectId,"upcoming"),tasklists:this.getProjectTasklists(s.projectId)},e.push(s.projectId),t.push(a)}),t},this),this.tasklists=ko.pureComputed(()=>{var t,e;return t=[],e=[],ko.utils.arrayForEach(this.filteredTasks(),s=>{var a;if(t.indexOf(s.tasklistId)<0)return a={tasklistId:s.tasklistId,tasklistName:s.tasklistName,projectId:s.projectId,tasks:this.getTasklistTasks(s.tasklistId)},t.push(s.tasklistId),e.push(a)}),e},this),this.getProjectTasklists=(t=>ko.utils.arrayFilter(this.tasklists(),e=>e.projectId===t)),this.getTasklistTasks=(t=>ko.utils.arrayFilter(this.filteredTasks(),e=>e.tasklistId===t)),this.getTaskCount=((t,e)=>{var s;return s=0,ko.utils.arrayForEach(this.tasks(),a=>{if(!e||e===a.taskType)return a.projectId===t?s++:void 0}),s}),this.currentProjectId.subscribe(t=>{t&&(document.getElementById("project-id").value=t,this.getTasklists(t))}),this.goBack=(()=>"add-task"===this.currentPage()&&this.currentProjectId()?this.currentPage("tasks-view"):this.currentPage("dashboard")),this.loginSuccess=(()=>{this.currentPage("splash"),this.loginError(""),this.domain(User.domain),this.userIcon(User.userIcon),this.userFirstname(User.userFirstname),this.userId(User.userId),this.getAllTasks(!0),this.getAllProjects()}),this.loginFail=(()=>{this.currentPage("login"),this.loginError("There was an error logging in. Please double check your API key.")}),this.logout=function(){localStorage.removeItem("auth"),window.location.reload(!0)},this.processLogin=function(){this.currentPage("splash"),this.User.auth({apiKey:document.getElementById("API-key").value,success:this.loginSuccess,fail:this.loginFail})},localStorage.getItem("auth")?this.User.auth({authHeader:localStorage.getItem("auth"),success:this.loginSuccess,fail:this.loginFail}):this.currentPage("login"),this.getAllTasks=((t,e)=>{var s;if(!this.loadingTasks())return this.loadingTasks(!0),s={url:this.domain()+"tasks.json",type:"GET",beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},data:{getFiles:!1,"responsible-party-ids":this.userId(),stamp:(new Date).getTime(),getSubTasks:"yes",sort:"duedate"},success:s=>{var a,r,i,o,n,l,h,u,d;if(this.prevResponse!==JSON.stringify(s)){for(this.prevResponse=JSON.stringify(s),r=[],o=0,n=(l=s["todo-items"]).length;o<n;o++)((u=l[o])["start-date"]||u["due-date"])&&(d="",h=u["start-date"],""!==(i=u["due-date"])&&i<this.today?d="late":""!==h&&h<=this.today||""!==i&&i===this.today?d="today":(""!==h&&h>this.today||""===h&&i>this.today)&&(d="upcoming"),a={taskName:u.content,taskId:u.id,tasklistId:u["todo-list-id"],tasklistName:u["todo-list-name"],projectId:u["project-id"],projectName:u["project-name"],taskDescription:marked(u.description),taskDescriptionRaw:u.description,taskStartDate:h,taskDueDate:i,taskType:d,subtaskCount:u.predecessors.length,subtasks:u.predecessors,parentId:u.parentTaskId,attachmentCount:u["attachments-count"],commentCount:u["comments-count"]},r.push(a));this.tasks(r),t&&this.currentPage("dashboard"),"function"==typeof e&&e(),this.loadingTasks(!1)}else this.loadingTasks(!1)}},$.ajax(s)}),this.getAllProjects=(()=>{var t;t={url:this.domain()+"projects.json",data:{pageSize:500},beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},success:t=>{ko.utils.arrayForEach(t.projects,t=>(t={text:t.name,value:t.id},this.allProjects.push(t))),this.getTasklists(document.getElementById("project-id").value)}},$.ajax(t)}),this.getTasklists=(t=>{var e;this.allTasklists([{id:"",text:"Loading tasklists..."}]),e={url:this.domain()+"projects/"+t+"/tasklists.json",data:{pageSize:500},beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},success:t=>{this.allTasklists([]),ko.utils.arrayForEach(t.tasklists,t=>(t={text:t.name,value:t.id},this.allTasklists.push(t))),this.allTasklists.push({text:"New tasklist...",value:"-1"})}},$.ajax(e)}),this.createTask=(()=>{var t,e,s,a,r,i,o,n,l,h,u,d;if(r=document.getElementById("start-date").value,e=document.getElementById("due-date").value,a=r?moment(r).format("YYYYMMDD"):"",t=e?moment(e).format("YYYYMMDD"):"",i=document.getElementById("task-name").value,l=document.getElementById("tasklist-id").value,h=document.getElementById("tasklist-name")?document.getElementById("tasklist-name").value:null,s=document.getElementById("project-id").value,t&&a>t)return alert("The start date can't be before the due date"),!1;o={"todo-item":{"responsible-party-id":this.userId(),"start-date":a,"due-date":t,content:i}},n={url:this.domain()+"tasklists/"+l+"/tasks.json",type:"POST",beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},contentType:"application/json",dataType:"json",data:JSON.stringify(o),success:t=>{this.getAllTasks(!1,function(){return this.getAllProjects(),this.currentProjectId()?this.currentPage("tasks-view"):this.currentPage("dashboard"),this.creatingTask(!1)})}},this.creatingTask(!0),h?(u={"todo-list":{name:h}},d={url:this.domain()+"projects/"+s+"/tasklists.json ",type:"POST",beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},contentType:"application/json",dataType:"json",data:JSON.stringify(u),success:t=>{n.url=this.domain()+"tasklists/"+t.TASKLISTID+"/tasks.json",$.ajax(n)}},$.ajax(d)):$.ajax(n)}),this.completeTask=(t=>{var e,s;(e=document.querySelector('[data-task-id="'+t+'"]')).classList.add("completed"),s={url:this.domain()+"tasks/"+t+"/complete.json",type:"PUT",beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},success:t=>{this.getAllTasks()},error:function(){return e.classList.remove("completed"),alert("There was an error completing the task")}},$.ajax(s)}),this.highlightSubtasks=(t=>{ko.utils.arrayForEach(this.tasks(),e=>{var s;parseInt(e.parentId)===parseInt(t)&&(s=document.querySelector('[data-task-id="'+e.taskId+'"]'))&&s.classList.toggle("highlight")})}),this.toggleDetails=function(t,e){var s;(s=e.target.nextSibling)&&s.classList.toggle("hidden")}},ko.applyBindings(viewModel);