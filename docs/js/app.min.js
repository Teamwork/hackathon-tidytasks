var markedRenderer,viewModel;(markedRenderer=new marked.Renderer).link=function(t,e,s){return'<a target="_blank" href="'+t+'" title="'+e+'" onclick="event.stopPropagation(); if(window.electronShell){electronShell.openExternal(this.href); return false;}; return true;">'+s+"</a>"},marked.setOptions({renderer:markedRenderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1}),viewModel=function(){this.currentPage=ko.observable("splash"),this.tasks=ko.observableArray(),this.currentFilter=ko.observable({type:"all",projectId:""}),this.allProjects=ko.observableArray(),this.allTasklists=ko.observableArray(),this.prevResponse="",this.startDate=ko.observable(moment(new Date).format("YYYY-MM-DD")),this.dueDate=ko.observable(""),this.initDatePickers=(()=>{this.startDatePicker=flatpickr("#start-date",{altInput:!0,defaultDate:"today"}),this.dueDatePicker=flatpickr("#due-date",{altInput:!0,minDate:"today"}),this.dueDatePicker.clear(),this.startDate.subscribe(t=>{this.dueDatePicker.set("minDate",t)})}),this.creatingTask=ko.observable(!1),this.loadingTasks=ko.observable(!1),this.selectedTasklist=ko.observable(),this.searchTerm=ko.observable("").extend({rateLimit:500}),this.User=new User,this.domain=ko.observable(),this.userId=ko.observable(),this.userIcon=ko.observable(),this.userFirstname=ko.observable(),this.previousPage=ko.observable(),this.showNav=ko.observable(!1),this.lightNav=ko.observable(!1),this.loginError=ko.observable(),this.today=moment(new Date).format("YYYYMMDD"),document.addEventListener("mousemove",()=>(this.autoRefresh&&clearInterval(this.autoRefresh),this.autoRefresh=this.setInterval(()=>this.getAllTasks(),6e4))),this.greeting=ko.pureComputed(()=>{var t;return(t=moment(new Date).format("HH"))<4?"Hey":t<12?"Good morning":t<17?"Good afternoon":"Good evening"}),this.totalTasks=ko.pureComputed(()=>this.tasks().length),this.totalLate=ko.pureComputed(()=>this.tasks().filter(function(t){return"late"===t.taskType}).length),this.totalToday=ko.pureComputed(()=>this.tasks().filter(function(t){return"today"===t.taskType}).length),this.totalUpcoming=ko.pureComputed(()=>this.tasks().filter(function(t){return"upcoming"===t.taskType}).length),this.searchResults=ko.pureComputed(()=>this.searchTerm()?this.tasks().filter(function(t){return t.taskName.toLowerCase().indexOf(searchTerm().toLowerCase())>-1||t.taskDescriptionRaw.toLowerCase().indexOf(searchTerm().toLowerCase())>-1}):[]),this.currentPage.subscribe(t=>{this.previousPage(t)},this,"beforeChange"),this.currentPage.subscribe(t=>{this.showNav(!0),["dashboard"].indexOf(t)>-1?(this.lightNav(!0),this.currentFilter({type:"all",projectId:""})):["add-task","project","tasks-view","search"].indexOf(t)>-1?this.lightNav(!1):this.showNav(!1)}),this.filteredTasks=ko.pureComputed(()=>this.tasks().filter(t=>(""===this.currentFilter().projectId||this.currentFilter().projectId===t.projectId)&&("all"===this.currentFilter().type||this.currentFilter().type===t.taskType)),this).extend({rateLimit:{timeout:0,method:"notifyWhenChangesStop"}}),this.filteredTasks.subscribe(t=>{0===t.length&&""!==this.currentFilter().projectId&&"all"!==this.currentFilter().type?this.currentFilter({type:"all",projectId:this.currentFilter().projectId}):0===t.length&&""!==this.currentFilter().projectId&&"all"===this.currentFilter().type?this.currentFilter({type:"all",projectId:""}):0===t.length&&""===this.currentFilter().projectId&&"all"===this.currentFilter().type&&(this.currentFilter({type:"all",projectId:""}),this.currentPage("dashboard"))}),this.projects=ko.pureComputed(()=>{var t,e;return e=[],t=[],this.tasks().forEach(s=>{var a;if(e.indexOf(s.projectId)<0)return a={projectId:s.projectId,projectName:s.projectName,taskCount:this.getTaskCount(s.projectId),lateCount:this.getTaskCount(s.projectId,"late"),todayCount:this.getTaskCount(s.projectId,"today"),upcomingCount:this.getTaskCount(s.projectId,"upcoming"),tasklists:this.getProjectTasklists(s.projectId)},e.push(s.projectId),t.push(a)}),t},this),this.tasklists=ko.pureComputed(()=>{var t,e;return t=[],e=[],this.tasks().forEach(s=>{var a;if(t.indexOf(s.tasklistId)<0)return a={tasklistId:s.tasklistId,tasklistName:s.tasklistName,projectId:s.projectId,tasks:this.getTasklistTasks(s.tasklistId)},t.push(s.tasklistId),e.push(a)}),e},this),this.getProjectTasklists=(t=>this.tasklists().filter(e=>e.projectId===t)),this.getTasklistTasks=(t=>this.filteredTasks().filter(e=>e.tasklistId===t)),this.getTaskCount=((t,e)=>{var s;return s=0,this.tasks().forEach(a=>{if(!e||e===a.taskType)return a.projectId===t?s++:void 0}),s}),this.currentFilter.subscribe(t=>{""!==t.projectId&&(document.getElementById("project-id").value=t.projectId,this.getTasklists(t.projectId))}),this.goBack=(()=>"add-task"===this.currentPage()&&""!==this.currentFilter().projectId?this.currentPage("tasks-view"):this.currentPage("dashboard")),this.loginSuccess=(()=>{this.currentPage("splash"),this.loginError(""),this.domain(User.domain),this.userIcon(User.userIcon),this.userFirstname(User.userFirstname),this.userId(User.userId),this.getAllTasks(!0),this.getAllProjects()}),this.loginFail=(()=>{this.currentPage("login"),this.loginError("There was an error logging in. Please double check your API key.")}),this.logout=function(){localStorage.removeItem("auth"),window.location.reload(!0)},this.processLogin=function(){this.currentPage("splash"),this.User.auth({apiKey:document.getElementById("API-key").value,success:this.loginSuccess,fail:this.loginFail})},localStorage.getItem("auth")?this.User.auth({authHeader:localStorage.getItem("auth"),success:this.loginSuccess,fail:this.loginFail}):this.currentPage("login"),this.getAllTasks=((t,e)=>{var s;if(!this.loadingTasks())return this.loadingTasks(!0),s={url:this.domain()+"tasks.json",type:"GET",beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},data:{getFiles:!1,"responsible-party-ids":this.userId(),stamp:(new Date).getTime(),getSubTasks:"yes",sort:"duedate"},success:s=>{var a,r,i,o,n,l,h,d,u;if(this.prevResponse!==JSON.stringify(s)){for(this.prevResponse=JSON.stringify(s),r=[],o=0,n=(l=s["todo-items"]).length;o<n;o++)((d=l[o])["start-date"]||d["due-date"])&&(u="",h=d["start-date"],""!==(i=d["due-date"])&&i<this.today?u="late":""!==h&&h<=this.today||""!==i&&i===this.today?u="today":(""!==h&&h>this.today||""===h&&i>this.today)&&(u="upcoming"),a={taskName:marked.inlineLexer(d.content,["links"]),taskNameRaw:d.content,taskId:d.id,tasklistId:d["todo-list-id"],tasklistName:d["todo-list-name"],projectId:d["project-id"],projectName:d["project-name"],taskDescription:marked(d.description),taskDescriptionRaw:d.description,taskStartDate:h,taskDueDate:i,taskType:u,subtaskCount:d.predecessors.length,parentId:d.parentTaskId,attachmentCount:d["attachments-count"],commentCount:d["comments-count"]},r.push(a));this.tasks(r),t&&this.currentPage("dashboard"),"function"==typeof e&&e(),this.loadingTasks(!1)}else this.loadingTasks(!1)}},$.ajax(s)}),this.getAllProjects=(()=>{var t;t={url:this.domain()+"projects.json",data:{pageSize:500},beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},success:t=>{var e;e=[],t.projects.forEach(t=>(t={text:t.name,value:t.id},e.push(t))),this.allProjects(e),this.getTasklists(document.getElementById("project-id").value)}},$.ajax(t)}),this.getTasklists=(t=>{var e;this.allTasklists([{id:"",text:"Loading tasklists..."}]),e={url:this.domain()+"projects/"+t+"/tasklists.json",data:{pageSize:500},beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},success:t=>{var e;e=[],t.tasklists.forEach(t=>(t={text:t.name,value:t.id},e.push(t))),this.allTasklists(e),this.allTasklists.push({text:"New tasklist...",value:"-1"})}},$.ajax(e)}),this.createTask=(()=>{var t,e,s,a,r,i,o,n;if(e=document.getElementById("task-name").value,r=document.getElementById("tasklist-id").value,i=document.getElementById("tasklist-name")?document.getElementById("tasklist-name").value:null,t=document.getElementById("project-id").value,dueDate&&startDate>dueDate)return alert("The start date can't be before the due date"),!1;s={"todo-item":{"responsible-party-id":this.userId(),"start-date":this.startDate()?moment(this.startDate()).format("YYYYMMDD"):"","due-date":this.dueDate()?moment(this.dueDate()).format("YYYYMMDD"):"",content:e}},a={url:this.domain()+"tasklists/"+r+"/tasks.json",type:"POST",beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},contentType:"application/json",dataType:"json",data:JSON.stringify(s),success:t=>{this.getAllTasks(!1,function(){return this.getAllProjects(),""!==this.currentFilter().projectId?this.currentPage("tasks-view"):this.currentPage("dashboard"),this.creatingTask(!1)})}},this.creatingTask(!0),i?(o={"todo-list":{name:i}},n={url:this.domain()+"projects/"+t+"/tasklists.json ",type:"POST",beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},contentType:"application/json",dataType:"json",data:JSON.stringify(o),success:t=>{a.url=this.domain()+"tasklists/"+t.TASKLISTID+"/tasks.json",$.ajax(a)}},$.ajax(n)):$.ajax(a)}),this.completeTask=(t=>{var e,s;(e=document.querySelectorAll('[data-task-id="'+t+'"]')).forEach(function(t){t.classList.add("completed")}),s={url:this.domain()+"tasks/"+t+"/complete.json",type:"PUT",beforeSend:function(t){t.setRequestHeader("Authorization",localStorage.getItem("auth"))},success:t=>{this.getAllTasks()},error:function(){return e.forEach(function(t){t.classList.remove("completed")}),alert("There was an error completing the task")}},$.ajax(s)}),this.getSubtasks=(t=>this.tasks().filter(function(e){return parseInt(e.parentId)===parseInt(t)})),this.toggleDetails=function(t){var e;(e=document.querySelector('[data-task-id="'+t+'"] .task-details'))&&e.classList.toggle("hidden")},this.initiated=!0},ko.applyBindings(viewModel),initDatePickers();